<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Chats | BilikMatch</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary: #673ab7; 
            --primary-light: #d1c4e9;
            --bg-gray: #f3f4f6;
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-gray); }

        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }

        /* Mobile View Logic */
        .chat-view-active #thread-list { display: none; }
        .chat-view-active #message-view { display: flex; }
        
        @media (min-width: 768px) {
            .chat-view-active #thread-list { display: flex; }
            .chat-view-active #message-view { display: flex; }
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <nav class="bg-[#673ab7] text-white shrink-0 shadow-md z-20">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <a href="../property_listing.html" class="hover:opacity-80 transition"><i class="fas fa-arrow-left"></i></a>
                <h1 class="text-lg font-bold tracking-wide">My Chats</h1>
            </div>
            <div class="flex items-center gap-4">
                <a href="../property_listing.html" class="text-white/80 hover:text-white text-sm font-medium">Discover</a>
                <a href="prof/profile.html" class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center hover:bg-white/30 transition">
                    <i class="fas fa-user text-xs"></i>
                </a>
            </div>
        </div>
    </nav>

    <main class="flex-1 flex max-w-7xl mx-auto w-full bg-white shadow-lg overflow-hidden md:my-4 md:rounded-2xl md:border border-gray-200">
        
        <aside id="thread-list" class="w-full md:w-80 lg:w-96 flex flex-col border-r border-gray-100 bg-white z-10">
            <div class="p-4 border-b border-gray-100">
                <div class="relative">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm"></i>
                    <input type="text" placeholder="Search chats..." class="w-full pl-9 pr-4 py-2 bg-gray-50 rounded-full text-sm focus:outline-none focus:ring-1 focus:ring-[#673ab7]">
                </div>
            </div>
            <div id="threads-container" class="flex-1 overflow-y-auto custom-scroll">
                <div class="p-8 text-center text-gray-400 text-sm animate-pulse">
                    <i class="fas fa-circle-notch fa-spin mr-2"></i>Loading chats...
                </div>
            </div>
        </aside>

        <section id="message-view" class="flex-1 hidden md:flex flex-col bg-[#f8fafc] relative">
            <div id="empty-chat-state" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400">
                <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                    <i class="fas fa-comments text-3xl text-gray-300"></i>
                </div>
                <p>Select a conversation to start chatting</p>
            </div>

            <header id="chat-header" class="hidden bg-white p-4 border-b border-gray-100 flex items-center justify-between shrink-0 shadow-sm z-10">
                <div class="flex items-center gap-3">
                    <button onclick="backToThreads()" class="md:hidden text-gray-500 hover:text-[#673ab7]"><i class="fas fa-arrow-left"></i></button>
                    <div class="relative">
                        <img id="header-avatar" src="" onerror="this.src='https://placehold.co/40x40/673ab7/ffffff?text=U'" class="w-10 h-10 rounded-full object-cover border border-gray-200">
                    </div>
                    <div>
                        <h2 id="header-name" class="font-bold text-gray-800 text-sm">User</h2>
                        <p id="connection-status" class="text-xs text-green-600 font-medium">Online</p>
                    </div>
                </div>
            </header>

            <div id="messages-container" class="hidden flex-1 overflow-y-auto p-4 space-y-4 custom-scroll"></div>

            <div id="chat-input-area" class="hidden bg-white p-4 border-t border-gray-100">
                <form id="message-form" class="flex items-end gap-2">
                    <button type="button" class="p-3 text-gray-400 hover:text-[#673ab7] transition"><i class="fas fa-plus-circle text-xl"></i></button>
                    <div class="flex-1 bg-gray-100 rounded-2xl px-4 py-2 focus-within:ring-1 focus-within:ring-[#673ab7] transition">
                        <textarea id="message-input" rows="1" placeholder="Type a message..." class="w-full bg-transparent border-none outline-none text-sm resize-none pt-2 max-h-32"></textarea>
                    </div>
                    <button type="submit" class="p-3 bg-[#673ab7] text-white rounded-full hover:bg-[#5e35b1] shadow-md transition transform active:scale-95">
                        <i class="fas fa-paper-plane text-sm"></i>
                    </button>
                </form>
            </div>
        </section>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore, collection, query, where, or, orderBy, onSnapshot, 
            doc, getDoc, addDoc, updateDoc, serverTimestamp, setDoc,
            enableIndexedDbPersistence 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
             apiKey: "AIzaSyBCCxQ0AYTHy6A6DrfW7ylYxjGW6AZA1OQ",
             authDomain: "whatsappclone-5ad8f.firebaseapp.com",
             projectId: "whatsappclone-5ad8f",
             storageBucket: "whatsappclone-5ad8f.firebasestorage.app",
             messagingSenderId: "1049878222012",
             appId: "1:1049878222012:web:54584a8098728e70acecb9"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        enableIndexedDbPersistence(db)
            .catch((err) => console.log("Persistence error:", err.code));

        window.addEventListener('online',  updateStatus);
        window.addEventListener('offline', updateStatus);
        function updateStatus() {
            const statusEl = document.getElementById('connection-status');
            if(statusEl) {
                statusEl.innerText = navigator.onLine ? "Online" : "Offline (Using Cache)";
                statusEl.className = navigator.onLine ? "text-xs text-green-600 font-medium" : "text-xs text-orange-500 font-medium";
            }
        }
        updateStatus();

        let currentUser = null;
        let currentThreadId = null;
        let messagesUnsubscribe = null;
        let activeThreadData = null;
        // ★ 修正1: 処理中のスナップショットを管理する変数
        let latestSnapshotId = 0; 

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                initChatList();
            } else {
                window.location.href = '../features/signin/sign_in.html';
            }
        });

        function initChatList() {
            const threadsContainer = document.getElementById('threads-container');
            const q = query(
                collection(db, "chats"),
                or(where("whoSent", "==", currentUser.uid), where("whoReceived", "==", currentUser.uid)),
                orderBy("timeStamp", "desc")
            );

            onSnapshot(q, async (snapshot) => {
                // ★ 修正2: 現在の処理IDを発行し、古い処理の結果を無視するようにする
                const currentSnapshotId = ++latestSnapshotId;

                if (snapshot.empty) {
                    if (currentSnapshotId === latestSnapshotId) {
                        threadsContainer.innerHTML = `<div class="p-8 text-center text-gray-400 text-sm">No conversations yet.</div>`;
                    }
                    return;
                }

                // ★ 修正3: forEachでの直接描画をやめ、データを配列にマップする
                const threadPromises = snapshot.docs.map(async (docSnapshot) => {
                    const data = docSnapshot.data();
                    const threadId = docSnapshot.id;
                    const otherUserId = data.whoSent === currentUser.uid ? data.whoReceived : data.whoSent;
                    
                    // 非同期でプロフィール取得
                    const userProfile = await fetchUserProfile(otherUserId);
                    
                    return {
                        threadId,
                        data,
                        userProfile,
                        otherUserId
                    };
                });

                // ★ 修正4: 全てのデータ取得が終わるまで待つ (Promise.all)
                const threadsData = await Promise.all(threadPromises);

                // ★ 修正5: 待っている間に新しいスナップショットが来ていたら、この古い結果は捨てる
                if (currentSnapshotId !== latestSnapshotId) return;

                // ★ 修正6: 一括描画 (これで順番通り、かつ重複なしになる)
                threadsContainer.innerHTML = '';
                
                threadsData.forEach(({ threadId, data, userProfile, otherUserId }) => {
                    const isSelected = threadId === currentThreadId;
                    const lastMsg = data.lastMessage || 'Attachment';
                    let timeDisplay = data.timeStamp ? moment(data.timeStamp.toDate()).fromNow(true) : '';
                    
                    const div = document.createElement('div');
                    div.className = `flex items-center gap-3 p-4 border-b border-gray-100 cursor-pointer hover:bg-gray-50 transition ${isSelected ? 'bg-purple-50 border-l-4 border-l-[#673ab7]' : ''}`;
                    div.onclick = () => openChat(threadId, otherUserId, userProfile);
                    
                    div.innerHTML = `
                        <img src="${userProfile.photoUrl || `https://placehold.co/100x100/673ab7/ffffff?text=${userProfile.name.charAt(0)}`}" class="w-12 h-12 rounded-full object-cover border border-gray-200">
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-baseline mb-1">
                                <h3 class="font-bold text-gray-800 text-sm truncate">${userProfile.name}</h3>
                                <span class="text-[10px] text-gray-400">${timeDisplay}</span>
                            </div>
                            <p class="text-xs text-gray-500 truncate ${data[`unreadCount_${currentUser.uid}`] > 0 ? 'font-bold text-gray-800' : ''}">
                                ${lastMsg}
                            </p>
                        </div>
                        ${data[`unreadCount_${currentUser.uid}`] > 0 ? `<div class="w-5 h-5 rounded-full bg-[#673ab7] text-white text-[10px] flex items-center justify-center font-bold">${data[`unreadCount_${currentUser.uid}`]}</div>` : ''}
                    `;
                    threadsContainer.appendChild(div);
                });
            });
        }

        async function fetchUserProfile(uid) {
            try {
                const snap = await getDoc(doc(db, "users_prof", uid));
                if (snap.exists()) return { name: snap.data().displayName || 'User', photoUrl: snap.data().profileImageUrl };
            } catch (e) {}
            return { name: 'User', photoUrl: null };
        }

        window.openChat = async (threadId, otherUserId, otherUserProfile) => {
            currentThreadId = threadId;
            activeThreadData = { otherUserId, ...otherUserProfile };

            document.body.classList.add('chat-view-active');
            document.getElementById('empty-chat-state').classList.add('hidden');
            document.getElementById('chat-header').classList.remove('hidden');
            document.getElementById('messages-container').classList.remove('hidden');
            document.getElementById('chat-input-area').classList.remove('hidden');

            document.getElementById('header-name').innerText = otherUserProfile.name;
            document.getElementById('header-avatar').src = otherUserProfile.photoUrl || `https://placehold.co/100x100/673ab7/ffffff?text=${otherUserProfile.name.charAt(0)}`;

            if (messagesUnsubscribe) messagesUnsubscribe();

            try {
                await updateDoc(doc(db, "chats", threadId), { [`unreadCount_${currentUser.uid}`]: 0 });
            } catch(e) {}

            const q = query(collection(db, "chats", threadId, "messages"), orderBy("timestamp", "asc"));
            const container = document.getElementById('messages-container');
            
            messagesUnsubscribe = onSnapshot(q, (snapshot) => {
                container.innerHTML = '';
                snapshot.forEach((docSnap) => {
                    const msg = docSnap.data();
                    renderMessage(container, msg, msg.whoSentId === currentUser.uid);
                });
                container.scrollTop = container.scrollHeight;
            });
            
            // Re-render chat list to highlight selection
            initChatList(); 
        };

        function renderMessage(container, msg, isMe) {
            const div = document.createElement('div');
            div.className = `flex ${isMe ? 'justify-end' : 'justify-start'} mb-4`;
            let contentHtml = '';

            if (msg.messageType === 'text') {
                contentHtml = `<p class="text-sm leading-relaxed whitespace-pre-wrap">${msg.text}</p>`;
            } else if (msg.messageType === 'property_template') {
                try {
                    const propData = JSON.parse(msg.text);
                    const coverImg = (propData.photoUrls && propData.photoUrls.length > 0) ? propData.photoUrls[0] : 'https://placehold.co/300x200?text=No+Image';
                    contentHtml = `
                        <div class="bg-white rounded-lg overflow-hidden w-64 shadow-sm border border-gray-100/50">
                            <div class="h-32 bg-gray-200 relative">
                                <img src="${coverImg}" class="w-full h-full object-cover">
                                <div class="absolute bottom-2 left-2 bg-black/60 text-white text-[10px] px-2 py-1 rounded font-bold">RM ${propData.rent}</div>
                            </div>
                            <div class="p-3">
                                <h4 class="font-bold text-gray-800 text-sm truncate mb-1">${propData.name || 'Property'}</h4>
                                <p class="text-xs text-gray-500 mb-2 truncate"><i class="fas fa-map-marker-alt mr-1"></i>${propData.location || 'Unknown'}</p>
                                <a href="../features/property_detail.html?id=${propData.postId}" target="_blank" class="block text-center w-full py-1.5 bg-[#673ab7] hover:bg-[#5e35b1] text-white text-xs font-bold rounded transition">View Details</a>
                            </div>
                        </div>`;
                } catch (e) { contentHtml = `<p class="text-red-500 text-xs italic">Error loading property</p>`; }
            } else if (msg.messageType === 'image') {
                contentHtml = `<img src="${msg.remoteUrl}" onerror="this.src='https://placehold.co/200x200?text=Image+Error'" class="rounded-lg max-w-[200px] cursor-pointer hover:opacity-90 transition bg-gray-100">`;
            }

            const bubbleClass = isMe ? 'bg-[#673ab7] text-white rounded-2xl rounded-tr-sm shadow-md' : 'bg-white text-gray-800 border border-gray-100 rounded-2xl rounded-tl-sm shadow-sm';
            const timeStr = msg.timestamp ? moment(msg.timestamp.toDate()).format('h:mm A') : '...';

            div.innerHTML = `
                <div class="max-w-[80%] md:max-w-[60%]">
                    <div class="px-4 py-3 ${bubbleClass} ${msg.messageType === 'property_template' ? '!p-0 !bg-transparent !shadow-none !border-none' : ''}">
                        ${contentHtml}
                    </div>
                    <p class="text-[10px] text-gray-400 mt-1 ${isMe ? 'text-right' : 'text-left'}">${timeStr}</p>
                </div>`;
            container.appendChild(div);
        }

        document.getElementById('message-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if (!text || !currentThreadId) return;
            input.value = '';

            try {
                await addDoc(collection(db, "chats", currentThreadId, "messages"), {
                    text: text, messageType: 'text', whoSentId: currentUser.uid, whoReceivedId: activeThreadData.otherUserId, timestamp: serverTimestamp(), isRead: false, operation: 'normal'
                });
                await setDoc(doc(db, "chats", currentThreadId), {
                    lastMessage: text, timeStamp: serverTimestamp(), whoSent: currentUser.uid, whoReceived: activeThreadData.otherUserId, [`unreadCount_${activeThreadData.otherUserId}`]: 1, participants: [currentUser.uid, activeThreadData.otherUserId]
                }, { merge: true });
            } catch (err) { console.error("Error sending message:", err); }
        });

        window.backToThreads = () => {
            document.body.classList.remove('chat-view-active');
            currentThreadId = null;
            if (messagesUnsubscribe) messagesUnsubscribe();
        };
    </script>
</body>
</html>